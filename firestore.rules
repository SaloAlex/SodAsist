rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Funciones auxiliares
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function getUserRole(userId) {
      let userDoc = get(/databases/$(database)/documents/users/$(userId));
      return userDoc != null ? userDoc.data.rol : null;
    }

    function isAdmin(userId) {
      return getUserRole(userId) == 'admin';
    }

    // Reglas para usuarios - Simplificadas para permitir el primer registro
    match /users/{userId} {
      allow create: if isAuthenticated() && 
        (request.auth.uid == userId || // Usuario creando su propio documento
         request.resource.data.rol == 'admin'); // Permitir creaci√≥n de admin
      allow read, update, delete: if isAuthenticated() && 
        (isOwner(userId) || // Usuario puede ver/editar sus propios datos
         isAdmin(request.auth.uid)); // Admin puede ver/editar todos los usuarios
    }

    // Reglas para tenants - Simplificadas
    match /tenants/{tenantId} {
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.adminUid; // Solo el admin puede crear su tenant
      allow read, write: if isAuthenticated() && 
        (request.auth.uid == resource.data.adminUid || // Owner del tenant
         isAdmin(request.auth.uid)); // Admin del sistema
    }

    // Reglas para datos de tenant
    match /tenants/{tenantId}/{collection}/{document=**} {
      allow read, write: if isAuthenticated() && 
        (request.auth.uid == resource.data.adminUid || // Owner del tenant
         isAdmin(request.auth.uid)); // Admin del sistema
    }

    // Reglas para colecciones globales (compatibilidad)
    match /{collection}/{document=**} {
      allow read, write: if isAuthenticated() && 
        (collection == 'users' || // Usuarios (manejado arriba)
         collection == 'tenants'); // Tenants (manejado arriba)
    }
  }
}